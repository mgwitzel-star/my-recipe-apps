<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Kitchen Pro</title>
    <style>
        :root { --primary: #2ecc71; --dark: #2c3e50; --gray: #f4f7f6; --blue: #3498db; --red: #e74c3c; --purple: #9b59b6; }
        body { font-family: system-ui, sans-serif; margin: 0; background: var(--gray); padding: 10px; padding-bottom: 50px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin-top: 0; font-size: 1.1rem; color: var(--dark); border-bottom: 2px solid #eee; padding-bottom: 8px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-main { background: var(--primary); width: 100%; }
        .btn-purple { background: var(--purple); width: 100%; }
        .btn-outline { background: white; border: 2px solid var(--blue); color: var(--blue); padding: 5px 10px; font-size: 0.8rem; }
        .status-msg { font-size: 0.8rem; padding: 5px; color: var(--purple); font-style: italic; display: none; }
        .day-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .recipe-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .recipe-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #ddd; }
        .budget-bar { background: var(--dark); color: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; position: sticky; top: 5px; z-index: 100; }
    </style>
</head>
<body>

<div class="container">
    <div class="budget-bar">
        <span>Est. Budget</span>
        <span id="budgetDisplay" style="font-size: 1.4rem;">$0.00</span>
    </div>

    <div class="card" style="border: 2px solid var(--purple);">
        <h2 style="color: var(--purple);">‚ö° Universal Web Scraper</h2>
        <input type="text" id="urlInput" placeholder="Paste Recipe Link (e.g. AllRecipes)">
        <div id="scrapeStatus" class="status-msg">Searching for ingredients...</div>
        <button class="btn-purple" id="scrapeBtn" onclick="runScraper()">Import from Web</button>
    </div>

    <div class="card" style="border-left: 5px solid var(--blue);">
        <h2>üìÖ Weekly Plan</h2>
        <div id="calendar-area"></div>
        <button class="btn-main" style="background: var(--dark); margin-top: 10px;" onclick="syncPlan()">üõí Sync Plan to List</button>
    </div>

    <div class="card">
        <h2 id="formTitle">üìù Recipe Editor</h2>
        <input type="hidden" id="editId">
        <input type="text" id="name" placeholder="Recipe Name">
        <input type="text" id="img" placeholder="Image URL (Optional)">
        <textarea id="ings" rows="5" placeholder="Ingredients (e.g. 1 cup Milk, Dairy)"></textarea>
        <button class="btn-main" onclick="saveRecipe()">Save to Cookbook</button>
    </div>

    <div class="card">
        <h2>üë®‚Äçüç≥ My Cookbook</h2>
        <div id="recipe-area"></div>
    </div>

    <div class="card">
        <h2>üõí Shopping List</h2>
        <div id="grocery-area"></div>
        <button class="btn-main" style="background: #95a5a6; margin-top: 15px;" onclick="clearGroceries()">Clear List</button>
    </div>
</div>

<script>
    let recipes = JSON.parse(localStorage.getItem('ck_recipes')) || [];
    let plan = JSON.parse(localStorage.getItem('ck_plan')) || { Mon:"", Tue:"", Wed:"", Thu:"", Fri:"", Sat:"", Sun:"" };
    let groceries = JSON.parse(localStorage.getItem('ck_groceries')) || [];
    let prices = JSON.parse(localStorage.getItem('ck_prices')) || {};
    const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    // --- ENHANCED SCRAPER ---
    async function runScraper() {
        const url = document.getElementById('urlInput').value;
        const btn = document.getElementById('scrapeBtn');
        const status = document.getElementById('scrapeStatus');
        if (!url) return alert("Paste a URL first!");

        btn.disabled = true;
        status.style.display = "block";
        status.innerText = "Connecting to proxy... (This takes 5-10 seconds)";

        try {
            // We use AllOrigins but add a cache-buster to avoid "old" or "blocked" results
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&td=${Date.now()}`);
            const data = await response.json();
            
            if (!data.contents) throw new Error("Could not reach site.");
            
            const doc = new DOMParser().parseFromString(data.contents, 'text/html');

            // Find Title: Search h1, then meta tags, then title tag
            const title = doc.querySelector('h1')?.innerText || 
                          doc.querySelector('meta[property="og:title"]')?.content || 
                          doc.querySelector('title')?.innerText;
            
            document.getElementById('name').value = (title || "New Recipe").trim();

            // Find Ingredients: Aggressive search across <li>, <span>, and classes containing "ingredient"
            const ingSelectors = ['li', 'span', '[class*="ingredient"]', '[id*="ingredient"]'];
            const units = ['cup', 'tsp', 'tbsp', 'lb', 'oz', 'gram', 'kg', 'clove', 'pinch', 'can', 'pkg', 'ml'];
            let foundIngs = [];

            ingSelectors.forEach(sel => {
                doc.querySelectorAll(sel).forEach(el => {
                    const t = el.innerText.trim();
                    // Must have a number OR a measurement unit to be an ingredient
                    const isIng = /\d/.test(t) || units.some(u => t.toLowerCase().includes(u));
                    if (isIng && t.length > 3 && t.length < 120) foundIngs.push(t);
                });
            });

            // De-duplicate and filter out common "junk" lines
            const junk = ["search", "follow", "pinterest", "instagram", "subscribe", "email"];
            const cleanIngs = [...new Set(foundIngs)].filter(t => !junk.some(j => t.toLowerCase().includes(j)));

            document.getElementById('ings').value = cleanIngs.join('\n');
            status.innerText = `‚úÖ Found ${cleanIngs.length} ingredients! Review and Save below.`;
            
            if(cleanIngs.length === 0) alert("Connected, but couldn't find ingredients. Try the manual copy-paste method.");
            
        } catch (e) {
            status.innerText = "‚ùå Site blocked scraper.";
            alert("This website blocks automated tools. Try AllRecipes.com or copy-paste the text manually into the Ingredients box.");
        } finally {
            btn.disabled = false;
        }
    }

    // --- MATH & CORE ---
    function scale(text, factor) {
        return text.replace(/((?:\d+\/\d+|\d+(?:\.\d+)?))/g, (match) => {
            let num = match.includes('/') ? (match.split('/')[0] / match.split('/')[1]) : parseFloat(match);
            return +(num * factor).toFixed(2);
        });
    }

    function saveRecipe() {
        const name = document.getElementById('name').value.trim();
        const img = document.getElementById('img').value.trim();
        const ingRaw = document.getElementById('ings').value.split('\n').filter(l => l.trim() !== "");
        const id = document.getElementById('editId').value;
        if (!name) return alert("Enter a name!");

        const rData = {
            id: id ? parseInt(id) : Date.now(),
            name, img, scale: 1,
            ingredients: ingRaw.map(l => {
                const p = l.split(',');
                return { item: p[0].trim(), aisle: (p[1] || 'general').trim().toLowerCase() };
            })
        };

        if (id) recipes[recipes.findIndex(r => r.id == id)] = rData;
        else recipes.push(rData);

        localStorage.setItem('ck_recipes', JSON.stringify(recipes));
        resetForm(); render();
    }

    function render() {
        document.getElementById('calendar-area').innerHTML = days.map(d => `
            <div class="day-row">
                <span class="day-label">${d}</span>
                <span class="day-meal">${plan[d] || "---"}</span>
                <button class="btn-outline" onclick="setDay('${d}')">Set</button>
            </div>`).join('');

        document.getElementById('recipe-area').innerHTML = recipes.map(r => `
            <div class="recipe-item">
                <img src="${r.img || 'https://via.placeholder.com/50'}" class="recipe-img">
                <div style="flex-grow:1">
                    <strong>${r.name}</strong><br>
                    <button class="btn-outline" onclick="toggleScale(${r.id})">${r.scale}x</button>
                    <button class="btn-outline" onclick="addOne(${r.id})">üõí</button>
                    <button class="btn-outline" onclick="editRec(${r.id})">‚úèÔ∏è</button>
                </div>
                <button style="background:var(--red); padding:5px 10px;" onclick="deleteRec(${r.id})">√ó</button>
            </div>`).join('');

        let total = 0;
        document.getElementById('grocery-area').innerHTML = groceries.map((g, i) => {
            const clean = g.item.replace(/[0-9/.]+/g, '').trim().toLowerCase();
            const p = prices[clean] || 0; total += p;
            return `<div class="grocery-row">
                <span>${g.item} <small>(${g.aisle})</small></span>
                <div>
                    $<input type="number" step="0.01" value="${p}" style="width:60px; padding:4px;" onchange="upPrice('${clean}', this.value)">
                    <button style="background:var(--red); padding:2px 8px;" onclick="remG(${i})">√ó</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('budgetDisplay').innerText = `$${total.toFixed(2)}`;
    }

    function setDay(d) {
        const choice = prompt(`Set ${d}:`, recipes.map(r => r.name).join(", "));
        if (choice !== null) { plan[d] = choice; localStorage.setItem('ck_plan', JSON.stringify(plan)); render(); }
    }
    function syncPlan() {
        days.forEach(d => {
            if (plan[d]) {
                const r = recipes.find(rec => rec.name.toLowerCase() === plan[d].toLowerCase());
                if (r) r.ingredients.forEach(i => groceries.push({ item: scale(i.item, r.scale), aisle: i.aisle }));
            }
        });
        localStorage.setItem('ck_groceries', JSON.stringify(groceries)); render();
    }
    function toggleScale(id) { const r = recipes.find(rec => rec.id == id); r.scale = r.scale == 1 ? 2 : 1; render(); }
    function addOne(id) { const r = recipes.find(rec => rec.id == id); r.ingredients.forEach(i => groceries.push({ item: scale(i.item, r.scale), aisle: i.aisle })); localStorage.setItem('ck_groceries', JSON.stringify(groceries)); render(); }
    function upPrice(n, p) { prices[n] = parseFloat(p) || 0; localStorage.setItem('ck_prices', JSON.stringify(prices)); render(); }
    function remG(i) { groceries.splice(i, 1); localStorage.setItem('ck_groceries', JSON.stringify(groceries)); render(); }
    function clearGroceries() { groceries = []; localStorage.setItem('ck_groceries', JSON.stringify(groceries)); render(); }
    function deleteRec(id) { recipes = recipes.filter(r => r.id != id); localStorage.setItem('myRecipes', JSON.stringify(recipes)); render(); }
    function resetForm() { document.getElementById('editId').value = ''; document.getElementById('name').value = ''; document.getElementById('img').value = ''; document.getElementById('ings').value = ''; document.getElementById('formTitle').innerText = "üìù Recipe Editor"; }
    function editRec(id) {
        const r = recipes.find(rec => rec.id == id);
        document.getElementById('editId').value = r.id;
        document.getElementById('name').value = r.name;
        document.getElementById('img').value = r.img;
        document.getElementById('ings').value = r.ingredients.map(i => `${i.item}, ${i.aisle}`).join('\n');
        document.getElementById('formTitle').innerText = "‚úèÔ∏è Edit Recipe";
        window.scrollTo(0,0);
    }
    render();
</script>
</body>
</html>
