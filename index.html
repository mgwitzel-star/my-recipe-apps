<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Kitchen Pro</title>
    <style>
        :root { --primary: #2ecc71; --dark: #2c3e50; --gray: #f4f7f6; --accent: #9b59b6; --blue: #3498db; --warning: #f39c12; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--gray); color: var(--dark); padding: 15px; padding-bottom: 50px; }
        .container { max-width: 650px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Aisle Styling */
        .aisle-badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; color: white; font-weight: bold; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }
        .aisle-produce { background: #27ae60; }
        .aisle-meat { background: #e74c3c; }
        .aisle-dairy { background: #3498db; }
        .aisle-pantry { background: #f39c12; }
        .aisle-frozen { background: #9b59b6; }
        .aisle-general { background: #95a5a6; }

        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 18px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.96); }

        .recipe-row { display: flex; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .thumb { width: 55px; height: 55px; border-radius: 10px; object-fit: cover; background: #eee; flex-shrink: 0; border: 1px solid #ddd; }
        
        .grocery-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .checked { opacity: 0.4; text-decoration: line-through; }
        .price-input { width: 75px !important; margin: 0 !important; padding: 5px !important; text-align: right; }
        .budget-bar { background: var(--dark); color: white; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <div class="budget-bar">
        <span>Estimated Total</span>
        <span id="totalPrice" style="font-size: 1.6rem; font-weight: bold;">$0.00</span>
    </div>

    <div class="card" style="margin-top:20px">
        <h2 id="formTitle">üìù Recipe Editor</h2>
        <input type="hidden" id="editId">
        <input type="text" id="recipeName" placeholder="Recipe Name">
        <input type="text" id="recipeImg" placeholder="Image URL (Paste link here)">
        <textarea id="ingredientsInput" rows="4" placeholder="Ingredients (e.g. 2 cups Milk, Dairy)"></textarea>
        <textarea id="howToInput" rows="2" placeholder="Cooking Steps..."></textarea>
        <button style="width: 100%" onclick="saveRecipe()">Save to Cookbook</button>
        <button style="width: 100%; background:#95a5a6; margin-top:5px; display:none;" id="cancelBtn" onclick="cancelEdit()">Cancel Edit</button>
    </div>

    <div class="card">
        <h2>üë®‚Äçüç≥ My Cookbook</h2>
        <div id="recipeList"></div>
    </div>

    <div class="card">
        <h2>üõí Shopping List</h2>
        <div id="shoppingList"></div>
        <button style="width: 100%; background: #95a5a6; margin-top: 15px;" onclick="clearGroceries()">Clear List</button>
    </div>
</div>

<script>
    let recipes = JSON.parse(localStorage.getItem('myRecipes')) || [];
    let groceryList = JSON.parse(localStorage.getItem('myGroceries')) || [];
    let priceBook = JSON.parse(localStorage.getItem('myPriceBook')) || {};

    const aisleClasses = { produce: 'aisle-produce', meat: 'aisle-meat', dairy: 'aisle-dairy', pantry: 'aisle-pantry', frozen: 'aisle-frozen', general: 'aisle-general' };

    function saveRecipe() {
        const name = document.getElementById('recipeName').value;
        const img = document.getElementById('recipeImg').value;
        const rawIngs = document.getElementById('ingredientsInput').value.split('\n');
        const howTo = document.getElementById('howToInput').value;
        const editId = document.getElementById('editId').value;

        if(!name) return alert("Recipe name required!");

        const ingredients = rawIngs.filter(l => l.trim() !== "").map(l => {
            const parts = l.split(',');
            return { 
                item: parts[0].trim(), 
                aisle: (parts[1] || 'general').trim().toLowerCase(),
                checked: false 
            };
        });

        if (editId) {
            const idx = recipes.findIndex(r => r.id == editId);
            recipes[idx] = { ...recipes[idx], name, img, ingredients, howTo };
        } else {
            recipes.push({ id: Date.now(), name, img, ingredients, howTo });
        }
        localStorage.setItem('myRecipes', JSON.stringify(recipes));
        cancelEdit();
        render();
    }

    function render() {
        // Cookbook Render
        const listDiv = document.getElementById('recipeList');
        listDiv.innerHTML = recipes.map(r => `
            <div class="recipe-row">
                <img src="${r.img || 'https://via.placeholder.com/60?text=Food'}" class="thumb">
                <div style="flex-grow:1">
                    <strong style="font-size:1.1rem">${r.name}</strong><br>
                    <button class="btn-small" style="margin-top:5px" onclick="addToCart(${r.id})">üõí Add All</button>
                    <button class="btn-small" style="background:var(--warning)" onclick="editRec(${r.id})">‚úèÔ∏è</button>
                    <button class="btn-small" style="background:none; color:red" onclick="deleteRec(${r.id})">√ó</button>
                </div>
            </div>
        `).join('');

        // Grocery Render (Sorted by Aisle)
        groceryList.sort((a, b) => a.aisle.localeCompare(b.aisle));
        let total = 0;
        document.getElementById('shoppingList').innerHTML = groceryList.map((ing, idx) => {
            // Clean name for price book matching
            const nameOnly = ing.item.replace(/[0-9/.]+\s*(cup|tsp|tbsp|oz|lb|g|ml|unit|pkg|can)s?\s+/gi, '').trim().toLowerCase();
            const p = priceBook[nameOnly] || 0;
            total += p;
            return `
                <div class="grocery-item ${ing.checked ? 'checked' : ''}">
                    <span onclick="toggleCheck(${idx})" style="cursor:pointer; flex-grow:1">
                        ${ing.item} <span class="aisle-badge ${aisleClasses[ing.aisle] || 'aisle-general'}">${ing.aisle}</span>
                    </span>
                    <div>
                        $ <input type="number" class="price-input" value="${p}" onchange="updatePrice('${nameOnly}', this.value)">
                        <button style="background:none; color:red; border:none; font-size:1.2rem;" onclick="removeG(${idx})">√ó</button>
                    </div>
                </div>`;
        }).join('');
        document.getElementById('totalPrice').innerText = `$${total.toFixed(2)}`;
    }

    function addToCart(id) {
        const r = recipes.find(rec => rec.id === id);
        groceryList = [...groceryList, ...JSON.parse(JSON.stringify(r.ingredients))];
        localStorage.setItem('myGroceries', JSON.stringify(groceryList));
        render();
    }

    function updatePrice(name, price) {
        priceBook[name] = parseFloat(price) || 0;
        localStorage.setItem('myPriceBook', JSON.stringify(priceBook));
        render();
    }

    function toggleCheck(idx) {
        groceryList[idx].checked = !groceryList[idx].checked;
        localStorage.setItem('myGroceries', JSON.stringify(groceryList));
        render();
    }

    function removeG(idx) {
        groceryList.splice(idx, 1);
        localStorage.setItem('myGroceries', JSON.stringify(groceryList));
        render();
    }

    function editRec(id) {
        const r = recipes.find(rec => rec.id === id);
        document.getElementById('recipeName').value = r.name;
        document.getElementById('recipeImg').value = r.img || '';
        document.getElementById('ingredientsInput').value = r.ingredients.map(i => `${i.item}, ${i.aisle}`).join('\n');
        document.getElementById('howToInput').value = r.howTo || '';
        document.getElementById('editId').value = r.id;
        document.getElementById('formTitle').innerText = "‚úèÔ∏è Edit Recipe";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('editId').value = '';
        document.querySelectorAll('input, textarea').forEach(i => i.value = '');
        document.getElementById('formTitle').innerText = "üìù Recipe Editor";
        document.getElementById('cancelBtn').style.display = "none";
    }

    function deleteRec(id) {
        if(confirm("Delete recipe?")) {
            recipes = recipes.filter(r => r.id !== id);
            localStorage.setItem('myRecipes', JSON.stringify(recipes));
            render();
        }
    }

    function clearGroceries() {
        if(confirm("Clear shopping list?")) {
            groceryList = [];
            localStorage.setItem('myGroceries', JSON.stringify(groceryList));
            render();
        }
    }

    render();
</script>
</body>
</html>
